<!DOCTYPE html>

<html
  lang="en"
  class="light-style layout-navbar-fixed layout-menu-fixed layout-compact"
  dir="ltr"
  data-theme="theme-default"
  data-assets-path=""
  data-template="vertical-menu-template">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />

    <title>DataTables - Tables | Materialize - Material Design HTML Admin Template</title>

    <meta name="description" content="" />

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="img/favicon/favicon.ico" />
    <link href="css/fonts.css"  rel="stylesheet" />
    <link href="css/css2.css"  rel="stylesheet" />

    <!-- Icons -->
    <link rel="stylesheet" href="vendor/fonts/materialdesignicons.css" />
    <link rel="stylesheet" href="vendor/fonts/flag-icons.css" />

    <!-- Menu waves for no-customizer fix -->
    <link rel="stylesheet" href="vendor/libs/node-waves/node-waves.css" />

    <!-- Core CSS -->
    <link rel="stylesheet" href="vendor/css/rtl/core.css" class="template-customizer-core-css" />
    <link rel="stylesheet" href="vendor/css/rtl/theme-default.css" class="template-customizer-theme-css" />
    <link rel="stylesheet" href="css/demo.css" />

    <!-- Vendors CSS -->
    <link rel="stylesheet" href="vendor/libs/perfect-scrollbar/perfect-scrollbar.css" />
    <link rel="stylesheet" href="vendor/libs/typeahead-js/typeahead.css" />
    <link rel="stylesheet" href="vendor/libs/datatables-bs5/datatables.bootstrap5.css" />
    <link rel="stylesheet" href="vendor/libs/datatables-responsive-bs5/responsive.bootstrap5.css" />
    <link rel="stylesheet" href="vendor/libs/datatables-checkboxes-jquery/datatables.checkboxes.css" />
    <link rel="stylesheet" href="vendor/libs/datatables-buttons-bs5/buttons.bootstrap5.css" />
    <link rel="stylesheet" href="vendor/libs/flatpickr/flatpickr.css" />
    <!-- Row Group CSS -->
    <link rel="stylesheet" href="vendor/libs/datatables-rowgroup-bs5/rowgroup.bootstrap5.css" />
    <!-- Form Validation -->
    <link rel="stylesheet" href="vendor/libs/@form-validation/umd/styles/index.min.css" />

    <!-- Page CSS -->

    <!-- Helpers -->
    <script src="vendor/js/helpers.js"></script>
    <!--! Template customizer & Theme config files MUST be included after core stylesheets and helpers.js in the <head> section -->
    <!--? Template customizer: To hide customizer set displayCustomizer value false in config.js.  -->
    <script src="vendor/js/template-customizer.js"></script>
    <!--? Config:  Mandatory theme config file contain global vars & default theme options, Set your preferred theme option in this file.  -->
    <script src="js/config.js"></script>
  </head>

  <body >
    <!-- Layout wrapper -->
    <div class="layout-wrapper layout-content-navbar" style="padding: 20px;">
      <div class="layout-container">
        <!-- Layout container -->
        <div>
          <!-- / Navbar -->

          <!-- Content wrapper -->
          <div class="content-wrapper">
            <!-- Content -->

              <!-- DataTable with Buttons -->
              <!-- Complex Headers -->
              <div class="card">
                <!-- <h5 class="card-header">วัตถุพยาน และตำแหน่งที่ตรวจพบ</h5> -->
                <div class="card-datatable text-nowrap">
                  <table class="dt-complex-header table table-bordered">
                    <thead>
                      <tr>
                        <th rowspan="2"></th>
                        <th rowspan="2">ป้ายหมายเลข</th>
                        <th rowspan="2">วัตถุพยาน</th>
                        <th colspan="4">ระยะห่าง (m) จากจุดอ้างอิง</th>
                        <th rowspan="2">Azimuth พิกัด/องศา/ระยะ</th>
                        <th rowspan="2">หมายเหตุ</th>
                        <th rowspan="2"></th>
                      </tr>
                      <tr>
                        <th>1</th>
                        <th>2</th>
                        <th>3</th>
                        <th>4</th>
                      </tr>
                    </thead>
                  </table>
                </div>
              </div>
              <!--/ Complex Headers -->

              <hr class="my-5" />

            </div>
            <br/><br/><br/><br/><br/><br/><br/><br/><br/><br/>
            <!-- / Content -->

            <div class="content-backdrop fade"></div>
          </div>
          <!-- Content wrapper -->
        </div>
        <!-- / Layout page -->
      </div>

      <!-- Overlay -->
      <div class="layout-overlay layout-menu-toggle"></div>

      <!-- Drag Target Area To SlideIn Menu On Small Screens -->
      <div class="drag-target"></div>
    </div>


    <div class="modal modal-top fade" id="modalTop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
          <div class="modal-dialog modal-fullscreen">
            <form class="modal-content" id="create_new_evidence">
              <div class="modal-header">
                <h4 class="modal-title" id="modalTopTitle">วัตถุพยาน</h4>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"></button>
              </div>
              <div class="modal-body">

                <form id="evidentForm" >
                        <div class="row mb-3">
                          <label class="col-sm-2 col-form-label" for="basic-default-name">วัตถุพยาน</label>
                          <div class="col-sm-10">
                            <input type="text" class="form-control" id="evident" />
                          </div>
                        </div>
                        <hr class="my-3 mx-n2" />
                        <input type="hidden" id="evident-id"/>

                        <h6>ระยะห่าง (m) ระหว่างจุดอ้างอิง</h6>
                        <div class="row mb-3">
                          <label class="col-sm-2 col-form-label" for="basic-default-company">จุดที่ 1</label>
                          <div class="col-sm-10">
                            <input
                              type="number" step="0.01" min="0"
                              class="form-control"
                              id="evident-one" />
                          </div>
                        </div>
                        <div class="row mb-3">
                          <label class="col-sm-2 col-form-label" for="basic-default-company">จุดที่ 2</label>
                          <div class="col-sm-10">
                            <input
                              type="number" step="0.01" min="0"
                              class="form-control"
                              id="evident-two" />
                          </div>
                        </div>
                        <div class="row mb-3">
                          <label class="col-sm-2 col-form-label" for="basic-default-company">จุดที่ 3</label>
                          <div class="col-sm-10">
                            <input
                              type="number" step="0.01" min="0"
                              class="form-control"
                              id="evident-three" />
                          </div>
                        </div>
                        <div class="row mb-3">
                          <label class="col-sm-2 col-form-label" for="basic-default-company">จุดที่ 4</label>
                          <div class="col-sm-10">
                            <input
                              type="number" step="0.01" min="0"
                              class="form-control"
                              id="evident-four"/>
                          </div>
                        </div>

                        <hr class="my-3 mx-n2" />
                        <div class="row mb-3">
                          <label class="col-sm-2 col-form-label" for="basic-default-name">Azimuth พิกัด/องศา/ระยะ</label>
                          <div class="col-sm-10">
                            <input type="text" class="form-control" id="evident-angle" />
                          </div>
                        </div>
                        <hr class="my-3 mx-n2" />
                        <div class="row mb-3">
                          <label class="col-sm-2 col-form-label" for="basic-default-name">หมายเหตุ</label>
                          <div class="col-sm-10">
                            <input type="text" class="form-control" id="evident-remark" />
                          </div>
                        </div>

                        <div class="row justify-content-end">
                          <div class="col-sm-10">
                            <button type="button" id="saveEvident" class="btn btn-primary">บันทึก</button>
                          </div>
                        </div>
                      </form>

              </div>
            </form>
          </div>
        </div>

        <!-- Large Modal -->
        <div class="modal modal-top fade" id="evidentDelete" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
          <div class="modal-dialog modal-fullscreen" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h4 class="modal-title" id="exampleModalLabel3">ลบข้อมูลวัตถุพยาน</h4>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"></button>
              </div>
              <div class="modal-body">
                คุณต้องการลบหรือไม่?
                <input type="hidden" id="deleteHidden" value=""/>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                  ปิด
                </button>
                <button type="button" id="deleteEvident" class="btn btn-danger">ลบ</button>
              </div>
            </div>
          </div>
        </div>
        <!-- Extra Large Modal -->

              
    <!-- / Layout wrapper -->

    <!-- Core JS -->
    <!-- build:js vendor/js/core.js -->
    <script src="vendor/libs/jquery/jquery.js"></script>
    <script src="vendor/libs/popper/popper.js"></script>
    <script src="vendor/js/bootstrap.js"></script>
    <script src="vendor/libs/node-waves/node-waves.js"></script>
    <script src="vendor/libs/perfect-scrollbar/perfect-scrollbar.js"></script>
    <script src="vendor/libs/hammer/hammer.js"></script>
    <script src="vendor/libs/i18n/i18n.js"></script>
    <script src="vendor/libs/typeahead-js/typeahead.js"></script>
    <script src="vendor/js/menu.js"></script>

    <!-- endbuild -->

    <!-- Vendors JS -->
    <script src="vendor/libs/datatables-bs5/datatables-bootstrap5.js"></script>
    <!-- Flat Picker -->
    <script src="vendor/libs/moment/moment.js"></script>
    <script src="vendor/libs/flatpickr/flatpickr.js"></script>
    <!-- Form Validation -->
    <script src="vendor/libs/@form-validation/umd/bundle/popular.min.js"></script>
    <script src="vendor/libs/@form-validation/umd/plugin-bootstrap5/index.min.js"></script>
    <script src="vendor/libs/@form-validation/umd/plugin-auto-focus/index.min.js"></script>

    <!-- Main JS -->
    <script src="js/main.js"></script>

    <!-- Page JS
    <script src="js/incident.js"></script>-->

    <script>
      $(function () {
            
            var jsonData = [];
            var jsonObject = [];

            if (typeof Android === "undefined") {
              jsonObject = [
                  { uid: 1, no: '1 Architect', evidence: 'evidence', distance_1: 'distance_1',distance_2:"xx", distance_3: 'distance_3', distance_4: 'distance_4',angle:"angle",remark:"remark"},
                  { uid: 1, no: '1 Architect', evidence: 'evidence', distance_1: 'distance_1',distance_2:"distance_2", distance_3: 'distance_3', distance_4: 'distance_4',angle:"angle",remark:"remark"}
              ];
            }else{
              jsonData = Android.getJsonData("","","");
              jsonObject = JSON.parse(jsonData);
            }
            
            //submitForm(jsonObject);
            
            var dt_basic_table = $('.dt-complex-header');
            dt_incident = dt_basic_table.DataTable({
                data: jsonObject,
                columns: [
                  { data: 'uid' },
                  { data: 'no' },
                  {  "className": "edit-cell",data: 'evidence' },
                  {  "className": "edit-cell",data: 'distance_1' },
                  {  "className": "edit-cell",data: 'distance_2' },
                  {  "className": "edit-cell",data: 'distance_3' },
                  {  "className": "edit-cell",data: 'distance_4' },
                  {  "className": "edit-cell",data: 'angle' },
                  {  "className": "edit-cell",data: 'remark' },
                  { data: 'uid' }
                ],
                columnDefs: [
                {
                    // For Responsive
                    className: 'control',
                    orderable: false,
                    searchable: false,
                    responsivePriority: 2,
                    targets: 0,
                    render: function (data, type, full, meta) {
                      return '';
                    }
                },
              {
                // For Checkboxes
                targets: 1,
                orderable: false,
                searchable: false,
                responsivePriority: 3,
                checkboxes: true,
                render: function (data, type, row) {
                  return '<input type="checkbox" class="dt-checkboxes form-check-input" value="'+row.uid.toString()+'" >';
                },
                checkboxes: {
                  selectAllRender: '<input type="checkbox" class="form-check-input">'
                }
              },
                {
                  responsivePriority: 1,
                  targets: 4
                },
                {
                  // Actions
                  targets: -1,
                  title: 'Actions',
                  orderable: false,
                  searchable: false,
                  render: function (data, type, full, meta) {
                    return (
                      '<button type="button" class="update-evident btn btn-icon btn-primary btn-fab demo waves-effect waves-light"><span class="tf-icons mdi mdi-pencil-outline mdi-24px"></span></button>'+
                      '<button type="button" class="delete-evident btn btn-icon btn-danger btn-fab demo waves-effect waves-light open-modal" ><span class="tf-icons mdi mdi-delete-outline mdi-24px"></span></button>'
                    );
                  }
                }
                ],
                order: [[2, 'desc']],
                dom: '<"card-header flex-column flex-md-row"<"head-label text-center"><"dt-action-buttons text-end pt-3 pt-md-0"B>><"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6 d-flex justify-content-center justify-content-md-end"f>>t<"row"<"col-sm-12 col-md-6"i><"col-sm-12 col-md-6"p>>',
                displayLength: 25,
                lengthMenu: [7, 10, 25, 50, 75, 100],
                buttons: [
                      
                      {
                        text: '<i class="mdi mdi-plus me-sm-1"></i> <span class="d-none d-sm-inline-block">สร้างวัตถุพยาน</span>',
                        className: 'create-label btn btn-secondary waves-effect waves-light'
                      },{
                        text: '<i class="mdi mdi-plus me-sm-1"></i> <span class="d-none d-sm-inline-block">วัตถุพยาน</span>',
                        className: 'create-new btn btn-primary waves-effect waves-light'
                        /*,
                        attr: {
                            'data-bs-toggle': 'modal',
                            'data-bs-target': '#modalTop'
                        }*/
                      }
                    ],
                responsive: {
                  details: {
                    display: $.fn.dataTable.Responsive.display.modal({
                      header: function (row) {
                        var data = row.data();
                        return 'Details of ' + data['full_name'];
                      }
                    }),
                    type: 'column',
                    renderer: function (api, rowIdx, columns) {
                      var data = $.map(columns, function (col, i) {
                        return col.title !== '' // ? Do not show row in modal popup if title is blank (for check box)
                          ? '<tr data-dt-row="' +
                              col.rowIndex +
                              '" data-dt-column="' +
                              col.columnIndex +
                              '">' +
                              '<td>' +
                              col.title +
                              ':' +
                              '</td> ' +
                              '<td>' +
                              col.data +
                              '</td>' +
                              '</tr>'
                          : '';
                      }).join('');

                      return data ? $('<table class="table"/><tbody />').append(data) : false;
                    }
                  }
                }

            })

            $('div.head-label').html('<h5 class="card-title mb-0">วัตถุพยาน และตำแหน่งที่ตรวจพบ</h5>');

            /*var jsonData = Android.getJsonData();
            create_dt(jsonData)
            dt_incident.clear();          // Clear existing data
            dt_incident.rows.add(newData); // Add new data
            dt_incident.draw(); */

            $('.dt-complex-header tbody').on('click', '.delete-record', function () {
              dt_basic.row($(this).parents('tr')).remove().draw();
            });

            //delete
            $('.dt-complex-header tbody').on('click', '.open-modal', function() {
              var data = dt_incident.row($(this).parents('tr')).data();
              $('#deleteHidden').val(data.uid.toString())
              //$('#evident-id').val('');
              // Show the modal
              $('#evidentDelete').modal('show');
            });

            //save
            $('#saveEvident').on('click', function() {
              //event.preventDefault(); // Prevent the default form submission
              //var form = $('#evidentForm')

              var evident = $('#evident').val();
              var evident1 = $('#evident-one').val();
              var evident2 = $('#evident-two').val();
              var evident3 = $('#evident-three').val();
              var evident4 = $('#evident-four').val();
              var angle = $('#evident-angle').val();
              var remark = $('#evident-remark').val();

              

              var evid = $('#evident-id').val()

              var json = {
                evident:evident,
                evident1:evident1,
                evident2:evident2,
                evident3:evident3,
                evident4:evident4,
                angle:angle,
                remark:remark,
                action:"",
                id:evid
              }

              if(evid != ""){
                json.action = "update"
              }else{
                json.action = "save"
              }
              submitForm(json)
              setTimeout(function() {
                  updateData()
              }, 1000); // 1000 milliseconds = 1 second
              
              $('#modalTop').modal('hide');
            });

            $('.create-new').on('click', function() {
                  var data = dt_incident.row($(this).parents('tr')).data();
                  $('#evident-id').val('');
                  $('#modalTop').modal('show');
                  $('#create_new_evidence')[0].reset();
            })

            $('.create-label').on('click', function() {
                  var data = dt_incident.row($(this).parents('tr')).data();

                  var ch = $('input.dt-checkboxes')
                  var selected = [];
                  $.each(ch, function() {
                     var checked = $(this).prop('checked')
                     if(checked){
                        selected.push($(this).val());
                     }
                  });


                  var jsonObject = {}
                  jsonObject["clone"] = selected.join(',')
                  jsonObject["action"] = "clone"
                  submitForm(jsonObject)
                  
            })


            //update
            $('.dt-complex-header tbody').on('click', '.update-evident', function() {
                  var data = dt_incident.row($(this).parents('tr')).data();

                  $('#evident-id').val(data.uid.toString());
                  $('#evident').val(data.evidence);
                  $('#evident-one').val(data.distance_1);
                  $('#evident-two').val(data.distance_2);
                  $('#evident-three').val(data.distance_3);
                  $('#evident-four').val(data.distance_4);
                  $('#evident-angle').val(data.angle);
                  $('#evident-remark').val(data.remark);

                  //$('#deleteHidden').val(data.uid.toString())
                  // Show the modal
                  $('#modalTop').modal('show');
            });

            $('.dt-complex-header tbody').on('click', 'td.edit-cell', function() {
                var cell = dt_incident.cell(this);

                if (cell.index().column !== undefined) {
                    var cellData = cell.data();
                    var input = $('<input type="text" class="form-control">').val(cellData);
                    $(this).html(input);

                    input.on('blur', function() {
                        cell.data(input.val()).draw();
                        var rowData = dt_incident.row(cell.index().row).data();
                        updateRow(rowData)
                    });

                    input.on('keypress', function(e) {
                        if (e.which == 13) { // Enter key pressed
                            cell.data(input.val()).draw();
                            var rowData = dt_incident.row(cell.index().row).data();
                            updateRow(rowData)
                        }
                    });

                    input.focus();
                }
            });

            $('.dt-complex-header tbody').on('change', 'input[type="checkbox"]', function() {
                //var isChecked = $(this).is(':checked');
                checkCheckBox()

            });

            $('.dt-complex-header thead').on('change', 'input[type="checkbox"]', function() {
                //var isChecked = $(this).is(':checked');
                checkCheckBox()
            });


            //delete
            $('#deleteEvident').click(function(){
              var uid = $('#deleteHidden').val()
              var json = {
                            uid:uid.toString(),
                            action:"delete"
                          }

              //console.log(json)
              submitForm(json)
              //dt_basic.row($(this).parents('tr')).remove().draw();
              $('#evidentDelete').modal('hide');
              updateData();
            })


      })

      function checkCheckBox(){
        var ch = $('input[type="checkbox"]')
        var someCheck = false;
        $.each(ch, function() {
           var checked = $(this).prop('checked')
           if(checked){
            someCheck = true
           }
        });

        if(someCheck == true){
          $(".create-label").removeClass('btn-secondary').addClass('btn-info');
        }else{
          $(".create-label").removeClass('btn-info').addClass('btn-secondary');
        }
      }
    </script>

    <script type="text/javascript">
        function updateRow(data){

            var json = {
                evident:data.evidence,
                evident1:data.distance_1,
                evident2:data.distance_2,
                evident3:data.distance_3,
                evident4:data.distance_4,
                angle:data.angle,
                remark:data.remark,
                action:"update",
                id:data.uid.toString()
              }
            submitForm(json)

        }

        function submitForm(jsonObject) {
          if (typeof Android === "undefined"){
          }else{
            Android.submitForm(JSON.stringify(jsonObject));
          }
        }

        function updateData() {
            // Call the Android method to get the current date
            var jsonData = "";
            var jsonObject = [];
           

            if (typeof Android === "undefined") {
              jsonObject = [
                  { uid: 1, no: 'sdf', evidence: 'test', distance_1: 'distance_1',distance_2:"xx", distance_3: 'testt', distance_4: 'distance_4',angle:"angle",remark:"remark"},
                  { uid: 1, no: '1 Architect', evidence: 'evidence', distance_1: 'distance_1',distance_2:"distance_2", distance_3: 'distance_3', distance_4: 'distance_4',angle:"angle",remark:"remark"}
              ];
            }else{
              jsonData = Android.getUpdateData();
              jsonObject = JSON.parse(jsonData);
            }
            dt_incident.clear();
            dt_incident.rows.add(jsonObject)
            dt_incident.draw();
        }
    </script>
  </body>
</html>
